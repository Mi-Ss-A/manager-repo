<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 관리자 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>ㄴ
</head>
<body class="bg-gray-100">
<div class="w-full max-w-7xl mx-auto p-4">
    <!-- 상단 헤더 섹션 -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold mb-2">통합 관리자 대시보드</h1>
            <p class="text-gray-600">서비스 메시 모니터링 및 상품 관리</p>
        </div>
    </div>

    <!-- 그리드 레이아웃: Istio 메트릭 + 관리자 기능 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 왼쪽: Istio 메트릭 섹션 -->
        <div class="lg:col-span-2 space-y-6">
            <!-- 메트릭 카드 섹션 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 총 서비스 카드 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b flex items-center space-x-2">
                        <i data-lucide="box" class="w-4 h-4"></i>
                        <h3 class="font-semibold">총 서비스</h3>
                    </div>
                    <div class="p-4">
                        <p class="text-2xl font-bold" th:text="${metrics.totalServices}">24</p>
                    </div>
                </div>

                <!-- 활성 게이트웨이 카드 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b flex items-center space-x-2">
                        <i data-lucide="terminal" class="w-4 h-4"></i>
                        <h3 class="font-semibold">활성 게이트웨이</h3>
                    </div>
                    <div class="p-4">
                        <p class="text-2xl font-bold" th:text="${metrics.activeGateways}">3</p>
                    </div>
                </div>

                <!-- 경고 카드 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b flex items-center space-x-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <h3 class="font-semibold">경고</h3>
                    </div>
                    <div class="p-4">
                        <p class="text-2xl font-bold" th:text="${metrics.alerts}">2</p>
                    </div>
                </div>
            </div>

            <!-- 시스템 상태 섹션 -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h3 class="font-semibold">시스템 상태</h3>
                </div>
                <div class="p-4">
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span>Virtual Services</span>
                            <span class="font-medium" th:text="${metrics.totalVirtualServices}">12</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Destination Rules</span>
                            <span class="font-medium" th:text="${metrics.totalDestinationRules}">8</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>네임스페이스</span>
                            <span class="font-medium" th:text="${metrics.totalNamespaces}">5</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>건강한 서비스</span>
                            <span class="font-medium" th:text="${metrics.healthyServices}">10</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>문제 있는 서비스</span>
                            <span class="font-medium" th:text="${metrics.unhealthyServices}">2</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>평균 지연 시간</span>
                            <span class="font-medium" th:text="${metrics.averageLatency + 'ms'}">150ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 오른쪽: 관리자 기능 섹션 -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">관리자 기능</h2>
                <div class="space-y-3">
                    <div class="space-y-2">
                        <h3 class="font-medium text-gray-700">상품 추가</h3>
                        <div class="space-y-2">
                            <a th:href="@{/card/add}" class="flex items-center p-2 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition">
                                <i data-lucide="credit-card" class="w-4 h-4 mr-2"></i>
                                카드 상품 추가
                            </a>
                            <a th:href="@{/loans/add}" class="flex items-center p-2 bg-green-50 text-green-700 rounded hover:bg-green-100 transition">
                                <i data-lucide="banknote" class="w-4 h-4 mr-2"></i>
                                대출 상품 추가
                            </a>
                            <a th:href="@{/fund/add}" class="flex items-center p-2 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 transition">
                                <i data-lucide="piggy-bank" class="w-4 h-4 mr-2"></i>
                                펀드 상품 추가
                            </a>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h3 class="font-medium text-gray-700">상품 조회</h3>
                        <div class="space-y-2">
                            <a th:href="@{/cards}" class="flex items-center p-2 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition">
                                <i data-lucide="credit-card" class="w-4 h-4 mr-2"></i>
                                카드 상품 목록
                            </a>
                            <a th:href="@{/loans}" class="flex items-center p-2 bg-green-50 text-green-700 rounded hover:bg-green-100 transition">
                                <i data-lucide="banknote" class="w-4 h-4 mr-2"></i>
                                대출 상품 목록
                            </a>
                            <a th:href="@{/funds}" class="flex items-center p-2 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 transition">
                                <i data-lucide="piggy-bank" class="w-4 h-4 mr-2"></i>
                                펀드 상품 목록
                            </a>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <h3 class="font-medium text-gray-700">사용자 관리</h3>
                        <a th:href="@{/userlists}" class="flex items-center p-2 bg-gray-50 text-gray-700 rounded hover:bg-gray-100 transition">
                            <i data-lucide="users" class="w-4 h-4 mr-2"></i>
                            사용자 목록 보기
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 서비스 선택 드롭다운 -->
    <div class="w-full mb-6">
        <select
                id="serviceSelector"
                class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                onchange="updateServiceMetrics(this.value)"
        >
            <option value="">서비스 선택</option>
            <option th:each="svc : ${SERVICE_NAMES}"
                    th:value="${svc}"
                    th:text="${svc}">서비스명</option>
        </select>
    </div>

    <!-- 서비스 메트릭스 섹션 -->
    <div th:each="service : ${SERVICE_NAMES}" th:id="'metrics-' + ${service}" style="display: none;" class="space-y-6">
        <!-- 피크 시간 정보 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-700 mb-2">피크 시간</h3>
                <p class="text-2xl font-bold text-blue-800"
                   th:text="${metricsistio['peakHours'].get(service)}">14:00</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-semibold text-green-700 mb-2">최대 트래픽</h3>
                <p class="text-2xl font-bold text-green-800"
                   th:text="${metricsistio['peakTraffic'].get(service)} + ' RPS'">1200 RPS</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-semibold text-purple-700 mb-2">필요 Pod 수</h3>
                <p class="text-2xl font-bold text-purple-800"
                   th:text="${metricsistio['requiredPods'].get(service)}">5</p>
            </div>
        </div>

        <!-- 스케일링 상태 타임라인 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-700 mb-2">이전 상태</h3>
                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-600"
                       th:text="${metricsistio['scalingTimeline'].get(service).get('beforeTime')}">13:00</p>
                    <p class="text-xl font-bold text-gray-800"
                       th:text="${metricsistio['scalingTimeline'].get(service).get('beforePods')} + ' pods'">2 pods</p>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-700 mb-2">현재 상태</h3>
                <div class="flex justify-between items-center">
                    <p class="text-sm text-blue-600"
                       th:text="${metricsistio['scalingTimeline'].get(service).get('currentTime')}">14:00</p>
                    <p class="text-xl font-bold text-blue-800"
                       th:text="${metricsistio['scalingTimeline'].get(service).get('currentPods')} + ' pods'">3 pods</p>
                </div>
            </div>

            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-semibold text-green-700 mb-2">예상 필요 상태</h3>
                <div class="flex justify-between items-center">
                    <p class="text-sm text-green-600">예상</p>
                    <p class="text-xl font-bold text-green-800"
                       th:text="${metricsistio['scalingTimeline'].get(service).get('expectedPods')} + ' pods'">4 pods</p>
                </div>
            </div>
        </div>

        <!-- 트래픽 차트 -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-semibold mb-4">시간대별 트래픽</h3>
            <div class="h-64">
                <canvas th:id="'trafficChart-' + ${service}"></canvas>
            </div>
        </div>
    </div>

    <!-- 서비스 선택에 따른 메트릭스 표시 제어를 위한 JavaScript -->
    <script th:inline="javascript">
        function updateServiceMetrics(selectedService) {
            // 모든 메트릭스 숨기기
            document.querySelectorAll('[id^="metrics-"]').forEach(element => {
                element.style.display = 'none';
            });

            // 선택된 서비스의 메트릭스만 표시
            if (selectedService) {
                const selectedMetrics = document.getElementById('metrics-' + selectedService);
                if (selectedMetrics) {
                    selectedMetrics.style.display = 'block';
                }
            }
        }

        // 페이지 로드 시 차트 초기화
        window.addEventListener('load', function() {
            const services = [[${SERVICE_NAMES}]];
            services.forEach(service => {
                const ctx = document.getElementById('trafficChart-' + service).getContext('2d');
                const trafficData = [[${metricsistio['hourlyTraffic']}]][service] || [];
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '트래픽 (RPS)',
                            data: trafficData,
                            borderColor: 'rgb(59, 130, 246)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        });
    </script>
    <!-- 푸터 -->
    <div class="mt-8 text-center text-gray-600">
        <p>© 2024 통합 관리자 대시보드 | Powered by WibeeChat</p>
    </div>
</div>

<script>
    // Lucide 아이콘 초기화
    lucide.createIcons();
</script>
</body>
</html>